<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mensagens Recebidas</title>
  <link rel="stylesheet" href="css/default.css" />
  <style>
    table { width:100%; border-collapse: collapse; margin-top: 12px;}
    th, td { border:1px solid #ccc; padding:8px; text-align:left; vertical-align:top;}
    th { background:#f4f4f4;}
    .acoes button{ margin-right:6px;}
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Mensagens</h1>
      <nav><a href="admin.html">Voltar ao login</a></nav>
    </header>

    <main>
      <div>
        <button id="atualizarBtn" class="button">Atualizar</button>
      </div>

      <div id="listaMensagens">
      </div>
    </main>
  </div>

  <footer>
    <p>© 2023 por Luxo aluguel de iates</p>
  </footer>

  <script src="js/jquery-3.6.4.min.js"></script>
  <script src="js/api.js"></script>

  <script>
  $(function(){

    var STORAGE_KEY = 'mensagens_local';

    function syncMensagensComApi() {
      var apiLista = [];
      try {
        var res = obterMensagens();
        if (Array.isArray(res)) apiLista = res;
      } catch(err) {
        console.warn('obterMensagens indisponível:', err);
      }

      var localList = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

      function existeNaLocal(m) {
        return localList.some(function(l){
          return l.nome === m.nome && l.email === m.email && l.mensagem === m.mensagem;
        });
      }

      apiLista.forEach(function(m){
        if (!existeNaLocal(m)) {
          var id = Date.now().toString() + Math.floor(Math.random()*1000).toString();
          localList.push({
            id: id,
            nome: m.nome || '',
            email: m.email || '',
            mensagem: m.mensagem || '',
            visualizada: false,
            criadoEm: new Date().toISOString()
          });
        }
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(localList));
      renderizar();
    }

    function renderizar() {
      var lista = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

      if (!lista.length) {
        $('#listaMensagens').html('<p>Nenhuma mensagem encontrada.</p>');
        return;
      }

      var html = '<table><thead><tr><th>Nome</th><th>E-mail</th><th>Mensagem</th><th>Criado Em</th><th>Ações</th></tr></thead><tbody>';
      lista.forEach(function(item){
        var estiloTexto = item.visualizada ? 'font-weight:normal;' : 'font-weight:bold;';
        html += '<tr data-id="' + item.id + '">';
        html += '<td style="'+ estiloTexto +'">'+ escapeHtml(item.nome) +'</td>';
        html += '<td style="'+ estiloTexto +'">'+ escapeHtml(item.email) +'</td>';
        html += '<td style="'+ estiloTexto +'">'+ escapeHtml(item.mensagem) +'</td>';
        html += '<td>'+ (item.criadoEm ? new Date(item.criadoEm).toLocaleString() : '') +'</td>';
        html += '<td class="acoes">';
        html += '<button class="btnVisualizada button">Mensagem Visualizada</button>';
        html += '<button class="btnExcluir button">Excluir Mensagem</button>';
        html += '</td>';
        html += '</tr>';
      });
      html += '</tbody></table>';

      $('#listaMensagens').html(html);
    }

    function escapeHtml(text) {
      if (!text && text !== 0) return '';
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    $('#listaMensagens').on('click', '.btnVisualizada', function(){
      var id = $(this).closest('tr').data('id');
      if (!confirm('Confirma marcar esta mensagem como visualizada?')) return;

      var lista = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      for (var i=0;i<lista.length;i++){
        if (lista[i].id === id) {
          lista[i].visualizada = true;
          break;
        }
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
      window.dispatchEvent(new StorageEvent('storage', {
        key: STORAGE_KEY,
        newValue: JSON.stringify(lista)
      }));
      renderizar();
    });

    $('#listaMensagens').on('click', '.btnExcluir', function(){
      var id = $(this).closest('tr').data('id');
      if (!confirm('Confirma excluir esta mensagem?')) return;

      var lista = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      lista = lista.filter(function(it){ return it.id !== id; });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
      window.dispatchEvent(new StorageEvent('storage', {
        key: STORAGE_KEY,
        newValue: JSON.stringify(lista)
      }));
      renderizar();
    });

    window.addEventListener('storage', function(e) {
      if (e.key === STORAGE_KEY || e.key === null) {
        renderizar();
      }
    });

    $('#atualizarBtn').on('click', function(){
      syncMensagensComApi();
    });

    syncMensagensComApi();
  });
  </script>
</body>
</html>
